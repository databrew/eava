---
title: "EAVA results"
author: "DataBrew LLC"
date: "5/4/2022"
output: 
  ioslides_presentation:
    widescreen: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      message = FALSE,
                      warning = FALSE)
library(tidyverse)
library(flextable)
library(knitr)
library(kableExtra)
source("eava.R")
```

```{r}
# causes is a list created by get_causes ; 
# 1st entry is primary cause, others are possible comborbidities
clean_causes <- function( causes ){
  primary_causes <- sapply(causes,"[[",1) 
  comorbidities <- character( length = length( primary_causes ) ) 
  for( i in 1:length( causes ) ){
    if( length(causes[[i]]) == 1 ){
      comorbidities[i] <- ""
    } else{
      comorbidities[i] <- paste0( causes[[i]][-1], collapse=", " )
    }
  }
  return( data.frame( Primary = primary_causes, Comorbidities = comorbidities) )
}

tabulate_causes <- function( cleaned_causes ){

  tallies <- cleaned_causes %>%
    group_by( Primary ) %>%
    tally( name="Count") 

  comorbid <-  cleaned_causes %>% 
    group_by(Primary) %>% 
    filter( Comorbidities != "") %>%
    summarize( Comorbidities = paste0( unique( unlist( strsplit( paste0(Comorbidities, collapse = ", "), ", ", fixed=TRUE))), collapse = ", "))

  return( tallies %>% left_join( comorbid, by="Primary" ) %>% arrange( desc(Count) ) )
}

print_causes <- function( causes ){
  tabulate_causes( clean_causes( causes ) ) %>%
    rename( "Possible comorbidities" = Comorbidities) %>%
    regulartable() %>% 
    theme_zebra() %>% 
    autofit()
}

```

# Overview

## EAVA

Expert Algorithms for Verbal Autopsy (EAVA) based on

> Kalter et al., [Direct estimates of national neonatal and child cause–specific mortality proportions in Niger by expert algorithm and physician–coded analysis of verbal autopsy interviews](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4416334/), J Glob Health. 2015 Jun; 5(1): 010415

and

> Liu et al., [Deriving causes of child mortality by re–analyzing national verbal autopsy data applying a standardized computer algorithm in Uganda, Rwanda and Ghana](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4467513/), J Glob Health. 2015 Jun; 5(1): 010414

## Kalter hierarchy 

<div style="float: left; width: 50%;">
<ol start="1">
<li>Injury</li>
<li>AIDS</li>
<li>Malnutrition (underlying)</li>
<li>Measles</li>
<li>Meningitis</li>
<li>Dysentery</li>
<li>Diarrhea</li>
<li>Pertussis</li>
<li>Pneumonia</li>
</ol>
</div>

<div style="float: right; width: 50%;">
<ol start="10">
<li>Malaria</li>
<li>Possible dysentery</li>
<li>Possible diarrhea</li>
<li>Possible pneumonia</li>
<li>Hemorrhagic fever</li>
<li>Other infection</li>
<li>Possible malaria</li>
<li>Malnutrition</li>
<li>Unspecified</li>
</ol>
</div>

## Liu hierarchy

1. Injury
2. Measles
3. Meningitis
4. Malaria
5. AIDS
6. Diarrhea
7. Acute Respiratory Infection
8. Possible pneumonia
9. Possible diarrhea
10. Unspecified
    
# Mali results

## CHAMPS_Verbal_Autopsy_Form_results

```{r}
df <- read_csv("data/mali_babel/CHAMPS_Verbal_Autopsy_Form_results_babel.csv", show_col_types = FALSE)
causes <- get_causes(df, format="champs2", algo="kalter", age_group="children")
print_causes( causes )
```

## CHAMPS_Verbal_Autopsy_Form_results

```{r}
df <- read_csv("data/mali_babel/CHAMPS_Verbal_Autopsy_Form_results_babel.csv", show_col_types = FALSE)
causes <- get_causes(df, format="champs2", algo="liu", age_group="children")
print_causes( causes )
```

## CHAMPS_Verbal_Autopsy_Form_v2_04_1_results

```{r}
df <- read_csv("data/mali_babel/CHAMPS_Verbal_Autopsy_Form_v2_04_1_results_babel.csv", show_col_types = FALSE)
causes <- get_causes(df, format="champs2", algo="kalter", age_group="children")
print_causes( causes )
```

## CHAMPS_Verbal_Autopsy_Form_v2_04_1_results

```{r}
df <- read_csv("data/mali_babel/CHAMPS_Verbal_Autopsy_Form_v2_04_1_results_babel.csv", show_col_types = FALSE)
causes <- get_causes(df, format="champs2", algo="liu", age_group="children")
print_causes( causes )
```

## CHAMPS_Verbal_Autopsy_Form_v2_04_results

```{r}
df <- read_csv("data/mali_babel/CHAMPS_Verbal_Autopsy_Form_v2_04_results_babel.csv", show_col_types = FALSE)
causes <- get_causes(df, format="champs2", algo="kalter", age_group="children")
print_causes( causes )
```

## CHAMPS_Verbal_Autopsy_Form_v2_04_results

```{r}
df <- read_csv("data/mali_babel/CHAMPS_Verbal_Autopsy_Form_v2_04_results_babel.csv", show_col_types = FALSE)
causes <- get_causes(df, format="champs2", algo="liu", age_group="children")
print_causes( causes )
```

## VA_Death_of_a_child_under_4_weeks_to_59_months_results_21MAR2018

```{r}
df <- read_csv("data/mali_babel/VA_Death_of_a_child_under_4_weeks_to_59_months_results_21MAR2018_babel.csv", show_col_types = FALSE)
causes <- get_causes(df, format="champs1", algo="kalter", age_group="children")
print_causes( causes )
```

## VA_Death_of_a_child_under_4_weeks_to_59_months_results_21MAR2018

```{r}
df <- read_csv("data/mali_babel/VA_Death_of_a_child_under_4_weeks_to_59_months_results_21MAR2018_babel.csv", show_col_types = FALSE)
causes <- get_causes(df, format="champs1", algo="liu", age_group="children")
print_causes( causes )
```

# Gambia results

## bn_hdss/VA_Child_WHO2016

```{r}
df <- read_csv("data/gambia_babel/bn_hdss/VA_Child_WHO2016_babel.csv", show_col_types = FALSE)
causes <- get_causes(df, format="c16", algo="kalter", age_group="children")
print_causes( causes )
```

## bn_hdss/VA_Child_WHO2016

```{r}
df <- read_csv("data/gambia_babel/bn_hdss/VA_Child_WHO2016_babel.csv", show_col_types = FALSE)
causes <- get_causes(df, format="c16", algo="liu", age_group="children")
print_causes( causes )
```

## bn_hdss/VA_ChildForm_WHO2012

```{r}
df <- read_csv("data/gambia_babel/bn_hdss/VA_ChildForm_WHO2012_babel.csv", show_col_types = FALSE)
causes <- get_causes(df, format="c12_16", algo="kalter", age_group="children")
print_causes( causes )
```

## bn_hdss/VA_ChildForm_WHO2012

```{r}
df <- read_csv("data/gambia_babel/bn_hdss/VA_ChildForm_WHO2012_babel.csv", show_col_types = FALSE)
causes <- get_causes(df, format="c12_16", algo="liu", age_group="children")
print_causes( causes )
```

## bs_hdss/VA_Child_Indepth_2008-2012_clean duration

```{r}
df <- read_csv("data/gambia_babel/bs_hdss/VA_Child_Indepth_2008-2012_clean duration_babel.csv", show_col_types = FALSE)
causes <- get_causes(df, format="c08_12", algo="kalter", age_group="children")
print_causes( causes )
```

## bs_hdss/VA_Child_Indepth_2008-2012_clean duration

```{r}
df <- read_csv("data/gambia_babel/bs_hdss/VA_Child_Indepth_2008-2012_clean duration_babel.csv", show_col_types = FALSE)
causes <- get_causes(df, format="c08_12", algo="liu", age_group="children")
print_causes( causes )
```

## bs_hdss/VA_Child_Indepth_2008-2012

```{r}
df <- read_csv("data/gambia_babel/bs_hdss/VA_Child_Indepth_2008-2012_babel.csv", show_col_types = FALSE)
causes <- get_causes(df, format="c08_12", algo="kalter", age_group="children")
print_causes( causes )
```

## bs_hdss/VA_Child_Indepth_2008-2012

```{r}
df <- read_csv("data/gambia_babel/bs_hdss/VA_Child_Indepth_2008-2012_babel.csv", show_col_types = FALSE)
causes <- get_causes(df, format="c08_12", algo="liu", age_group="children")
print_causes( causes )
```

## bs_hdss/VA_Child_WHO2012-mid 2016

```{r}
df <- read_csv("data/gambia_babel/bs_hdss/VA_Child_WHO2012-mid 2016_babel.csv", show_col_types = FALSE)
causes <- get_causes(df, format="c12_16", algo="kalter", age_group="children")
print_causes( causes )
```

## bs_hdss/VA_Child_WHO2012-mid 2016

```{r}
df <- read_csv("data/gambia_babel/bs_hdss/VA_Child_WHO2012-mid 2016_babel.csv", show_col_types = FALSE)
causes <- get_causes(df, format="c12_16", algo="liu", age_group="children")
print_causes( causes )
```

## bs_hdss/VA_Child_WHO2016

```{r}
df <- read_csv("data/gambia_babel/bs_hdss/VA_Child_WHO2016_babel.csv", show_col_types = FALSE)
causes <- get_causes(df, format="c16", algo="kalter", age_group="children")
print_causes( causes )
```

## bs_hdss/VA_Child_WHO2016

```{r}
df <- read_csv("data/gambia_babel/bs_hdss/VA_Child_WHO2016_babel.csv", show_col_types = FALSE)
causes <- get_causes(df, format="c16", algo="liu", age_group="children")
print_causes( causes )
```
